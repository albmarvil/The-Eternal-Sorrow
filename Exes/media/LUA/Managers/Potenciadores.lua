--author: César Manuel Paz Gumán

Potenciadores = 
{
	Positivos = { 
					probabilidad = 33, 

					lista = {
						probabilidadAcumuladaFinal = 0,
						
						VidaPos1 = {
							probabilidad = 40, 
							estadisticas =  { 
								vida = 1,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},		
						},
						VidaPos3 = {
							probabilidad = 30, 
							estadisticas =  { 
								vida = 3,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},		
						},
						VidaPos5 = {
							probabilidad = 19, 
							estadisticas =  { 
								vida = 5,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},		
						},
						AtaquePos1 = {
							probabilidad = 40, 
							estadisticas =  {
								vida = 0, 
								ataque = 1,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						AtaquePos3 = {
							probabilidad = 30, 
							estadisticas =  {
								vida = 0, 
								ataque = 3,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						AtaquePos5 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 5,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						VelAtaquePos1 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 1,
								velocidad_movimiento = 0,
							},
						},
						VelAtaquePos3 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 3,
								velocidad_movimiento = 0,
							},
						},
						VelAtaquePos5 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 5,
								velocidad_movimiento = 0,
							},
						},
						VelMovimientoPos1 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 1,
							},
						},
						VelMovimientoPos3 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 3,
							},
						},
						VelMovimientoPos5 = {
							probabilidad = 19, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 5,
							},
						},
						SaltoNivel = {
							probabilidad = 11, 
							estadisticas =  {
								vida = 1, 
								ataque = 1,
								velocidad_ataque = 1,
								velocidad_movimiento = 1,
							},
						},
						SubidaMayor = {
							probabilidad = 8, 
							estadisticas =  {
								vida = 3, 
								ataque = 3,
								velocidad_ataque = 3,
								velocidad_movimiento = 3,
							},
						},
						MaestriaTotal = {
							probabilidad = 5, 
							estadisticas =  {
								vida = 5, 
								ataque = 5,
								velocidad_ataque = 5,
								velocidad_movimiento = 5,
							},
						},
					},
				},

	Negativos = {
					probabilidad = 33,

					lista = {
						VidaNeg1 = {
							probabilidad = 10, 
							estadisticas =  {
								vida = -1,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						VidaNeg3 = {
							probabilidad = 10, 
							estadisticas =  {
								vida = -3,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						VidaNeg5 = {
							probabilidad = 10, 
							estadisticas =  {
								vida = -5,
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						AtaqueNeg = {
							probabilidad = 10, 
							estadisticas =  {
								vida = 0, 
								ataque = -1,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						AtaqueNeg3 = {
							probabilidad = 10, 
							estadisticas =  {
								vida = 0, 
								ataque = -3,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						AtaqueNeg5 = {
							probabilidad = 10, 
							estadisticas =  {
								vida = 0, 
								ataque = -5,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},
						VelAtaqueNeg1 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = -1,
								velocidad_movimiento = 0,
							},
						},
						VelAtaqueNeg3 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = -3,
								velocidad_movimiento = 0,
							},
						},
						VelAtaqueNeg5 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = -5,
								velocidad_movimiento = 0,
							},
						},
						VelMovimientoNeg1 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = -1,
							},
						},
						VelMovimientoNeg3 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = -3,
							},
						},
						VelMovimientoNeg5 = {
							probabilidad = 21, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = -5,
							},
						},
						SaltoHaciaAtras = {
							probabilidad = 11, 
							estadisticas =  {
								vida = -1, 
								ataque = -1,
								velocidad_ataque = -1,
								velocidad_movimiento = -1,
							},
						},

						PeroQueHasHecho = {
							probabilidad = 5,
							estadisticas =  {
								vida = -2, 
								ataque = -2,
								velocidad_ataque = -2,
								velocidad_movimiento = -2, 
							},
						},
					},
				},
	Neutros = 	{
					probabilidad = 34, 

					lista = {
						Berseker = {
							probabilidad = 20, 
							estadisticas =  {
								vida = -1, 
								ataque = 5,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},

						Paladin = {
							probabilidad = 20, 
							estadisticas =  {
								vida = 5, 
								ataque = -1,
								velocidad_ataque = 0,
								velocidad_movimiento = 0,
							},
						},

						Tortuga = {
							probabilidad = 20, 
							estadisticas =  {
								vida = 5, 
								ataque = 0,
								velocidad_ataque = 0,
								velocidad_movimiento = -2,
							},
						},

						Asesino = {
							probabilidad = 10, 
							estadisticas =  {
								vida = -2, 
								ataque = 0,
								velocidad_ataque = 3,
								velocidad_movimiento = 3,
							},
						},

						PiesLigeros = {
							probabilidad = 10, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = -1,
								velocidad_movimiento = 5,
							},
						},

						ManoRapida = {
							probabilidad = 10, 
							estadisticas =  {
								vida = 0, 
								ataque = 0,
								velocidad_ataque = 5,
								velocidad_movimiento = -1,
							},
						},

						Caballero = {
							probabilidad = 25, 
							estadisticas =  {
								vida = 3, 
								ataque = 3,
								velocidad_ataque = -1,
								velocidad_movimiento = -1,
							},
						},

						Picaro = {
							probabilidad = 15, 
							estadisticas =  {
								vida = -1, 
								ataque = -1,
								velocidad_ataque = 3,
								velocidad_movimiento = 3,
							},
						},
					},
				},
}

---Utilidades para ID y nombre sunicos de potenciadores
Potenciadores.PotID = 0

function Potenciadores.PotenciadorID()
	Potenciadores.PotID = Potenciadores.PotID + 1
	return Potenciadores.PotID
end

----





FuncionesPotenciadores = {}

--Potenciadores usados en la partida
FuncionesPotenciadores.PotenciadoresPartida = {
		--aqui apuntaremos el tipo de potenciador usado y el material asignado
}

--Numero de potenciadores maximo a usar en una partida
FuncionesPotenciadores.numMaxPotenciadores = 0

--TABLA CON LOS MATERIALES
FuncionesPotenciadores.MaterialesPotenciadores = {
		"Runa1", "Runa2", "Runa3", "Runa4", "Runa5", "Runa6", "Runa7", "Runa8", "Runa9", "Runa10", "Runa11", "Runa12",
	"Runa13", "Runa14", "Runa15", "Runa16", "Runa17", "Runa18", "Runa19", "Runa20", "Runa21", "Runa22", "Runa23", "Runa24"
}

FuncionesPotenciadores.ParticulasPotenciadores = {
	"PotenciadorAzul", "PotenciadorAmarillo", "PotenciadorVerde", "PotenciadorRojo",
}

function FuncionesPotenciadores.posicionMaterial(nombreMaterial)
	for key, value in pairs(FuncionesPotenciadores.MaterialesPotenciadores) do
		if value == nombreMaterial then
			return key
		end
	end
end
FuncionesPotenciadores.MaterialesPartida = {
	
}


--FUNCION QUE DEVUELVE EL NOMBRE DEL POTENCIADOR SEGUN EL PESO
function FuncionesPotenciadores.nombrePotenciador(probabilidad, nombreTabla)

	for key, value in pairs(nombreTabla) do
		if type(value) == "table" then

			if probabilidad <= value.probabilidadAcumulada then
				return key
			end 

		end
	end
end

--FUNCION QUE ACTUALIZA LOS STATS DEL PLAYER
function FuncionesPotenciadores.ActualizarStats(tabla)
	--actualizamos la tabla de estadísticas del palyer
	Data_Player.UpdateStats(tabla)
end

--FUNCION QUE IMPRIME LOS STATS DEL JUGADOR
function FuncionesPotenciadores.DebugEstadisticasPersonaje()
	Log.Debug("vida: "..Data_Player.player_stats.vida)
	Log.Debug("ataque: "..Data_Player.player_stats.ataque)
	Log.Debug("velocidad_ataque: "..Data_Player.player_stats.velocidad_ataque)
	Log.Debug("velocidad_movimiento: "..Data_Player.player_stats.velocidad_movimiento)
end



function FuncionesPotenciadores.AcumuladorProbabilidades(key,value,probabilidadAcumulada)
	for key2, value2 in pairs(value) do
		if(key2 == "probabilidad") then
			value.probabilidadAcumulada = probabilidadAcumulada + value2
			-- Log.Debug("Nombre: "..key.." ProbabilidadAcumulada: "..value.probabilidadAcumulada)
			return value.probabilidadAcumulada
		end
	end
end

function FuncionesPotenciadores.materialEnUso(material)
	-- body
	for k,v in pairs(FuncionesPotenciadores.MaterialesPartida) do
		if v == material then
			return true
		end
	end
	return false
end

--FUNCION QUE ASIGNA LOS POTENCIADORES QUE APARECERAN EN UNA PARTIDA
function FuncionesPotenciadores.potenciadoresDePartidaActual()

	-- print(FuncionesPotenciadores.numMaxPotenciadores)
	for i=1, FuncionesPotenciadores.numMaxPotenciadores do

		-- print("ITER: "..i)
		
		local tipo = nil
		local tipoKey = nil

		local tipoEspecifico = nil
		local tipoEspecificoKey = nil
		repeat

			-- print("probabilidadAcumuladaFinal: "..Potenciadores.probabilidadAcumuladaFinal)
			-- local rnd2 = math.random(Potenciadores.probabilidadAcumuladaFinal)
			local rnd2 = Random(Potenciadores.probabilidadAcumuladaFinal)
			-- Log.Debug("potenciadoresDePartidaActual tipo RND: "..rnd2) 
			
			for key, value in pairs(Potenciadores) do
				if type(value) == "table" then

					if rnd2 <= value.probabilidadAcumulada then
						tipo = value
						tipoKey = key
						break
					end 

				end
			end

			--Obtengo la probabilidadAcumulada total y hago un random sobre el
			-- local rnd = math.random(Potenciadores[tipoKey].lista.probabilidadAcumuladaFinal)
			local rnd = Random(Potenciadores[tipoKey].lista.probabilidadAcumuladaFinal)
			-- Log.Debug("potenciadoresDePartidaActual tipoEspecifico RND: "..rnd)

			for key, value in pairs(tipo.lista) do
				if type(value) == "table" then

					if rnd <= value.probabilidadAcumulada then
						tipoEspecifico = value
						tipoEspecificoKey = key
						break
					end 

				end
			end
		until not FuncionesPotenciadores.esPotenciadorUsado(tipoKey, tipoEspecificoKey)

		--En este punto ya tenemos el tipo y tipo específico y sabemos que son potenciadores NO usados en la partida.

		--le asignamos un material y lo metemos como potenciador de partida
		local rndMaterial = nil
		local material = nil

		-- print ("TAM: "..table.getn(FuncionesPotenciadores.MaterialesPotenciadores))
		repeat
			-- rndMaterial = math.random(#FuncionesPotenciadores.MaterialesPotenciadores)
			rndMaterial = RandomElement(FuncionesPotenciadores.MaterialesPotenciadores) 
			material = FuncionesPotenciadores.MaterialesPotenciadores[rndMaterial]
			-- Log.Debug("potenciadoresDePartidaActual material RND: "..material)
		until not FuncionesPotenciadores.materialEnUso(material)

		tipoEspecifico.material = material

		table.insert(FuncionesPotenciadores.MaterialesPartida, material)

		if FuncionesPotenciadores.PotenciadoresPartida[tipoKey] == nil then
			FuncionesPotenciadores.PotenciadoresPartida[tipoKey] = {probabilidad = tipo.probabilidad, lista = {}}
		end
		-- print(tipoEspecificoKey, tipoEspecifico.material, tipoKey,FuncionesPotenciadores.PotenciadoresPartida[tipoKey])
		FuncionesPotenciadores.PotenciadoresPartida[tipoKey].lista[tipoEspecificoKey] = tipoEspecifico

	end

	--Me queda acumular potenciadores de partida actual
	

	local tablasAAcumular = { FuncionesPotenciadores.PotenciadoresPartida,}
	FuncionesPotenciadores.PotenciadoresPartida.probabilidadAcumuladaFinal = 0
	--añadimos las categorias de potenciadores que pueda haber, no todas tiene porque estar en la partida
	for k,v in pairs(FuncionesPotenciadores.PotenciadoresPartida) do
		if type(v) == "table" then
			table.insert(tablasAAcumular, v.lista)
			v.lista.probabilidadAcumuladaFinal = 0
		end
	end

	local probabilidadAcumulada = 0

	for key, value in pairs(tablasAAcumular) do
		
		for key2, value2 in pairs(value) do
			if type(value2) == "table" then
				probabilidadAcumulada = FuncionesPotenciadores.AcumuladorProbabilidades(key2, value2, probabilidadAcumulada)
			end
		end
		value.probabilidadAcumuladaFinal = probabilidadAcumulada
		probabilidadAcumulada = 0
	end

	Log.Debug("POTENCIADORES DE PARTIDA ACTUAL")
	for k,v in pairs(FuncionesPotenciadores.PotenciadoresPartida) do
		if type(v) == "table" then
			for k,v in pairs(v.lista) do
				if type(v) == "table" then
					Log.Debug("Nombre: "..k.." Material: "..v.material)
				end
			end
		end
			
	end 

end

function FuncionesPotenciadores.esPotenciadorUsado( tipo, tipoEspecifico )
	-- body

	if FuncionesPotenciadores.PotenciadoresPartida[tipo] ~= nil then

		return FuncionesPotenciadores.PotenciadoresPartida[tipo].lista[tipoEspecifico] ~= nil
	else
		return false
	end

end

--TABLA, QUE GUARDA LAS TABLAS SOBRE LAS QUE ACTUALIZAR LAS PROBABILIDADES ACUMULADAS
FuncionesPotenciadores.ActualizarProbabilidades = {
	Potenciadores, Potenciadores.Positivos.lista, Potenciadores.Negativos.lista, Potenciadores.Neutros.lista,
}

--FUNCTION QUE ACTUALIZA LAS PROBABILIDADAES ACUMULADAS, Y LA ACUMULADA FINAL
function Potenciadores.Init(numeroPotPartida)

	FuncionesPotenciadores.PotenciadoresPartida = {}
	FuncionesPotenciadores.numMaxPotenciadores = numeroPotPartida
	FuncionesPotenciadores.MaterialesPartida = {}

	local probabilidadAcumulada = 0
	Potenciadores.probabilidadAcumuladaFinal =0
	Potenciadores.Positivos.lista.probabilidadAcumuladaFinal = 0
	Potenciadores.Negativos.lista.probabilidadAcumuladaFinal = 0
	Potenciadores.Neutros.lista.probabilidadAcumuladaFinal = 0

	for key, value in pairs(FuncionesPotenciadores.ActualizarProbabilidades) do
		
		for key2, value2 in pairs(value) do
			if type(value2) == "table" then
				probabilidadAcumulada = FuncionesPotenciadores.AcumuladorProbabilidades(key2, value2, probabilidadAcumulada)
			end
		end

		value.probabilidadAcumuladaFinal = probabilidadAcumulada
		probabilidadAcumulada = 0
	end

	--ELEGIMOS LOS POTENCIADORES DE ESTA PARTIDA
	FuncionesPotenciadores.potenciadoresDePartidaActual()
end


--ESTA FUNCION SERA LLAMADA DESDE EL SCRIPTENTITY CORRESPONDIENTE AL COFRE, MUERTES DE ENEMIGOS, JEFES, OBJETOS ROMPIBLES
function Potenciadores.CreatePotenciador(position, minradio, maxradio, numPotenciadores)
	for i=1,numPotenciadores do
		

		--Escogemos el tipo de potenciador y tipo de potenciador especifico
		local tipo = nil
		local tipoKey = nil

		local tipoEspecifico = nil
		local tipoEspecificoKey = nil

		-- local rnd2 = math.random(FuncionesPotenciadores.PotenciadoresPartida.probabilidadAcumuladaFinal)
		local rnd2 = Random(FuncionesPotenciadores.PotenciadoresPartida.probabilidadAcumuladaFinal)
		-- Log.Debug("CreatePotenciador tipo RND: "..rnd2) 
				
		for key, value in pairs(FuncionesPotenciadores.PotenciadoresPartida) do
			if type(value) == "table" then

				if rnd2 <= value.probabilidadAcumulada then
					tipo = value
					tipoKey = key
					break
				end 

			end
		end

		-- local rnd = math.random(FuncionesPotenciadores.PotenciadoresPartida[tipoKey].lista.probabilidadAcumuladaFinal)
		local rnd = Random(FuncionesPotenciadores.PotenciadoresPartida[tipoKey].lista.probabilidadAcumuladaFinal)
		-- Log.Debug("CreatePotenciador tipoEspecifico RND: "..rnd) 		
		for key, value in pairs(tipo.lista) do
			if type(value) == "table" then

				if rnd <= value.probabilidadAcumulada then
					tipoEspecifico = value
					tipoEspecificoKey = key
					break
				end 

			end
		end

		--calculamos los limites inferiores del radio donde no queremos que aparezca el objeto
		local minHorInf = position.x - minradio
		local minHorSup = position.x + minradio

		--calculamos la posicion en la cual va a ir el potenciador
		--para ello calculamos los límites de aparicion del objeto

		local horInf = position.x - maxradio
		local horSup = position.x + maxradio
		local verInf = position.y --Con esto forzamos que el objeto salga por arriba del contenedor
		local verSup = position.y + maxradio


		local x = 0
		local y = 0
		local z = math.random(-2,2)
	    local z1 = math.random(0,9)
		local tileID = -1

		repeat
			x = math.random(horInf, horSup)
			y = math.random(verInf, verSup)
			tileID = GameMgr.getTile(x, y)
			--repetir hasta que el tile sea viable Y
			-- la coordenada X no este dentro del radio minimo
		until tileID == 0 and (x >= minHorSup or x <= minHorInf)

		x, y = GameMgr.positionToTilePosition(x, y)
		x = (20 * x) + math.random(-5, 5)
		y = (-20 * y) + math.random(-5, 5)

		---LA nueva posicion admisible para este potenciador es:
		local newPosition = Vector3(x,y,z)

		-- Log.Debug("Potenciador creado  Nombre: "..tipoEspecificoKey.." material: "..tipoEspecifico.material.."Particula"..tipoEspecifico.particula.." Position: ".."x "..position.x.." y: "..position.y.." z: "..position.z)

		--CREO EL ENTITYINFO
		local nombreUnico = tipoEspecificoKey..Potenciadores.PotenciadorID()

		local entityInfo = MapEntity(nombreUnico)
		entityInfo:SetAttrib("position", toString({newPosition.x, (newPosition.y), newPosition.z.."."..z1}))
		--entityInfo:SetAttrib("material", toString(tipoEspecifico.material))
		entityInfo:SetAttrib("tipoGeneral", toString(tipoKey))
		entityInfo:SetAttrib("tipoEspecifico", toString(tipoEspecificoKey))
		--entityInfo:SetAttrib("sourceParticles", toString(tipoEspecifico.particula))
		entityInfo:SetType("Potenciador"..FuncionesPotenciadores.posicionMaterial(tipoEspecifico.material))
		NewEntity(entityInfo, GameMgr.map)

	end	


end


